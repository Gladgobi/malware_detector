import time
import yara
import os
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler
from plyer import notification

print("Actively scanning the Downloads Directory")

# Define the directory you want to monitor
directory_to_watch = "/home/dharun/Downloads"  # Change this to your desired director

# Compile YARA rules for ransomware, trojans, and adware
ransomware_rule = yara.compile(filepath='wannacry.yar')
trojan_rule = yara.compile(filepath='Linux_Trojan_Mirai.yar')
adware_rule = yara.compile(filepath='Adware.DealPly.yar')  

class MyHandler(FileSystemEventHandler):
    def on_created(self, event):
        file_name = event.src_path
        if os.path.isfile(file_name):  # Check if it's a file
            try:
                with open(file_name, 'rb') as f:
                    file_data = f.read()
                    ransomware_matches = ransomware_rule.match(data=file_data)
                    trojan_matches = trojan_rule.match(data=file_data)
                    adware_matches = adware_rule.match(data=file_data)
                    
                    if ransomware_matches:
                        print("Type of Ransomware:", ransomware_matches)
                        print("File Name:", file_name)
                        notification_title = "New Suspected Ransomware Detected"
                        notification_text = f"Suspected Ransomware: {ransomware_matches}\nFile: {file_name}\nThis suspicious file will be removed in 5 seconds."
                        notification.notify(
                            title=notification_title,
                            message=notification_text,
                            app_name="RANSOMWARE DETECTOR",
                            timeout=10  # Notification display duration
                        )
                        time.sleep(5)
                        os.remove(file_name)
                    
                    elif trojan_matches:
                        print("Type of Trojan:", trojan_matches)
                        print("File Name:", file_name)
                        notification_title = "New Suspected Trojan Detected"
                        notification_text = f"Suspected Trojan: {trojan_matches}\nFile: {file_name}\nThis suspicious file will be removed in 5 seconds."
                        notification.notify(
                            title=notification_title,
                            message=notification_text,
                            app_name="TROJAN DETECTOR",
                            timeout=10  # Notification display duration
                        )
                        time.sleep(5)
                        os.remove(file_name)
                    
                    elif adware_matches:
                        print("Type of Adware:", adware_matches)
                        print("File Name:", file_name)
                        notification_title = "New Suspected Adware Detected"
                        notification_text = f"Suspected Adware: {adware_matches}\nFile: {file_name}\nThis suspicious file will be removed in 5 seconds."
                        notification.notify(
                            title=notification_title,
                            message=notification_text,
                            app_name="ADWARE DETECTOR",
                            timeout=10  # Notification display duration
                        )
                        time.sleep(5)
                        os.remove(file_name)
                    
                    else:
                        print("No malware detected in file:", file_name)
            
            except Exception as e:
                print(f"Error processing file: {file_name}\n{e}")

event_handler = MyHandler()
observer = Observer()
observer.schedule(event_handler, path=directory_to_watch, recursive=False)
observer.start()

try:
    while True:
        time.sleep(5)
except KeyboardInterrupt:
    observer.stop()

observer.join()

